/*
 * lcd.c
 *
 *  Created on: Mar 15, 2024
 *      Author: jeffr
 */
#include "lcd.h"

/*Defines -------------------------------------------*/
/* Commands*/
#define HD44780_CLEARDISPLAY        0x01
#define HD44780_RETURNHOME          0x02
#define HD44780_ENTRYMODESET        0x04
#define HD44780_DISPLAYCONTROL      0x08
#define HD44780_CURSORSHIFT         0x10
#define HD44780_FUNCTIONSET         0x20
#define HD44780_SETCGRAMADDR        0x40
#define HD44780_SETDDRAMADDR        0x80

/* Flags for display entry mode */
#define HD44780_ENTRYRIGHT          0x00
#define HD44780_ENTRYLEFT           0x02
#define HD44780_ENTRYSHIFTINCREMENT 0x01
#define HD44780_ENTRYSHIFTDECREMENT 0x00

/* Flags for display on/off control */
#define HD44780_DISPLAYON           0x04
#define HD44780_CURSORON            0x02
#define HD44780_BLINKON             0x01

/* Flags for display/cursor shift */
#define HD44780_DISPLAYMOVE         0x08
#define HD44780_CURSORMOVE          0x00
#define HD44780_MOVERIGHT           0x04
#define HD44780_MOVELEFT            0x00

/* Flags for function set */
#define HD44780_8BITMODE            0x10
#define HD44780_4BITMODE            0x00
#define HD44780_2LINE               0x08
#define HD44780_1LINE               0x00
#define HD44780_5x10DOTS            0x04
#define HD44780_5x8DOTS             0x00
/*Private function -----------------------------------*/
static void lcd_cmd(LCD_t *d, cmd);
static void lcd_data(LCD_t *d, data);
static void lcd_cursorSet(LCD_t *d, uint8_t col, uint8_t row);
/*Function definition --------------------------------*/
void lcd_init(LCD_t *d, lcd_write_nb_fc w, lcd_delay_fc del, uint8_t cols, uint8_t rows){
	if(LCD_ASSERT(d) || LCD_ASSERT(w) || LCD_ASSERT(del)){
		return;
	}
	d->writeNb = w;
	d->delay = del;
	d->Rows = rows;
	d->Cols = cols;
	/**
	 * init
	 */
	d->currentX = 0;
	d->currentY = 0;

	d->DisplayFunction = HD44780_4BITMODE | HD44780_5x8DOTS | HD44780_1LINE;
	if(d->Rows>1){
		d->DisplayFunction |=  HD44780_2LINE;
	}

	/*Init 4 bit mode*/
	d->writeNb(0x03, 0);
	d->delay(45);		//45ms

	d->writeNb(0x03, 0);
	d->delay(45);		//45ms

	d->writeNb(0x03, 0);
	d->delay(45);		//45ms

	d->writeNb(0x02, 0);
	d->delay(1);		//1ms

	lcd_cmd(d, HD44780_FUNCTIONSET | d->DisplayFunction);

	d->DisplayControl = HD44780_DISPLAYON;
	lcd_displayOn(d);

	lcd_clear(d);

	d->DisplayMode = HD44780_ENTRYLEFT | HD44780_ENTRYSHIFTDECREMENT;

	lcd_cmd(d, HD44780_ENTRYMODESET | d->DisplayMode);


	d->delay(45);
}
